name: Monthly data download check

on:
  schedule:
    - cron: "0 3 1 * *"
  workflow_dispatch:
    inputs:
      fn:
        description: "Função load_ a testar. Deixe vazio para testar todas."
        required: false
        default: ""

jobs:
  check-downloads:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      max-parallel: 4
      fail-fast: false
      matrix:
        fn:
          - load_aneel
          - load_baci
          - load_br_trade
          - load_censo_agro
          - load_climate
          - load_degrad
          - load_deter
          - load_epe
          - load_ibama
          - load_iema
          - load_imazon
          - load_ips
          - load_mapbiomas
          - load_pam
          - load_pevs
          - load_pibmunic
          - load_population
          - load_ppm
          - load_prodes
          - load_seeg
          - load_sigmine

    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.fn == '' ||
      github.event.inputs.fn == matrix.fn

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - name: System dependencies (sf/units)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgdal-dev \
            libgeos-dev \
            libproj-dev \
            libudunits2-dev \
            gdal-bin \
            proj-bin \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev

      - name: Install package dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            local::.
          needs: check

      - name: Run checks for one function
        run: |
          Rscript --vanilla actions/scripts/check_all_loads.R --fn ${{ matrix.fn }}

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: check-results-${{ matrix.fn }}
          path: check_results_${{ matrix.fn }}_*.csv


