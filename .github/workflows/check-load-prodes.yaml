name: Check load_prodes

on:
  schedule:
    - cron: "0 21 1 * *"
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
            df -h


      - name: System dependencies (sf/units)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgdal-dev \
            libgeos-dev \
            libproj-dev \
            libudunits2-dev \
            gdal-bin \
            proj-bin \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            local::.
          needs: check

      - name: Run checks for load_prodes
        run: |
          Rscript --vanilla actions/scripts/check_all_loads.R --fn load_prodes

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: check-results-load_prodes
          path: check_results_load_prodes_*.csv