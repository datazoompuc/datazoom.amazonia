<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Contribution Guide • datazoom.amazonia</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Contribution Guide">
<meta property="og:description" content="datazoom.amazonia">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">datazoom.amazonia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ANEEL.html">ANEEL</a>
    </li>
    <li>
      <a href="../articles/BACI.html">BACI</a>
    </li>
    <li>
      <a href="../articles/CEMPRE.html">CEMPRE</a>
    </li>
    <li>
      <a href="../articles/CIPO.html">CIPÓ</a>
    </li>
    <li>
      <a href="../articles/COMEX.html">COMEX</a>
    </li>
    <li>
      <a href="../articles/contribution_guide.html">Contribution Guide</a>
    </li>
    <li>
      <a href="../articles/DATASUS.html">DATASUS</a>
    </li>
    <li>
      <a href="../articles/DEGRAD.html">DEGRAD</a>
    </li>
    <li>
      <a href="../articles/DETER.html">DETER</a>
    </li>
    <li>
      <a href="../articles/EPE.html">EPE</a>
    </li>
    <li>
      <a href="../articles/GOOGLEDRIVE.html">GOOGLEDRIVE</a>
    </li>
    <li>
      <a href="../articles/IBAMA.html">IBAMA</a>
    </li>
    <li>
      <a href="../articles/IEMA.html">IEMA</a>
    </li>
    <li>
      <a href="../articles/IMAZON.html">IMAZON</a>
    </li>
    <li>
      <a href="../articles/IPS.html">Social Progress Index</a>
    </li>
    <li>
      <a href="../articles/MAPBIOMAS.html">MAPBIOMAS</a>
    </li>
    <li>
      <a href="../articles/municipalities.html">legal_amazon</a>
    </li>
    <li>
      <a href="../articles/PAM.html">PAM</a>
    </li>
    <li>
      <a href="../articles/PEVS.html">PEVS</a>
    </li>
    <li>
      <a href="../articles/PIBMUNIC.html">PIBMUNIC</a>
    </li>
    <li>
      <a href="../articles/PPM.html">PPM</a>
    </li>
    <li>
      <a href="../articles/PRODES.html">PRODES</a>
    </li>
    <li>
      <a href="../articles/SEEG.html">SEEG</a>
    </li>
    <li>
      <a href="../articles/SIGMINE.html">SIGMINE</a>
    </li>
    <li>
      <a href="../articles/TERRACLIMATE.html">TerraClimate</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="contribution_guide_files/htmlwidgets-1.6.1/htmlwidgets.js"></script><script src="contribution_guide_files/viz-1.8.2/viz.js"></script><link href="contribution_guide_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="contribution_guide_files/grViz-binding-1.0.9/grViz.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Contribution Guide</h1>
            
      
      
      <div class="hidden name"><code>contribution_guide.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="contributing-to-datazoom-amazonia">Contributing to datazoom.amazonia<a class="anchor" aria-label="anchor" href="#contributing-to-datazoom-amazonia"></a>
</h2>
<p>Please follow this workflow when contributing to
<code>datazoom.amazonia</code>:<br>
1. Fork the repository under your own user<br>
2. Clone the repository locally<br>
3. Create a new branch for your changes<br>
4. Add your changes to the branch<br>
5. Commit your changes<br>
6. Push your branch to the remote repository<br>
7. Create a pull request on GitHub</p>
</div>
<div class="section level2">
<h2 id="working-on-existing-issues">Working on existing issues<a class="anchor" aria-label="anchor" href="#working-on-existing-issues"></a>
</h2>
<p>If you intend to work on an issue, leave a comment and state your
intentions. Also feel free to ask for clarifications if you’re not sure
what the issue entails. If you don’t understand an issue, it’s on us,
not on you!</p>
</div>
<div class="section level2">
<h2 id="general-structure-of-our-functions">General structure of our functions<a class="anchor" aria-label="anchor" href="#general-structure-of-our-functions"></a>
</h2>
<p>The point of the sections below is to present the structure of the
<code>datazoom.amazonia</code> functions, and share our workflow of how
to create new functions.</p>
<p>We will add as many examples as possible to show how things actually
work, and this document should be continuously improved upon, adding new
sections as our functions are changed.</p>
</div>
<div class="section level2">
<h2 id="a-new-function">A new function<a class="anchor" aria-label="anchor" href="#a-new-function"></a>
</h2>
<p>The starting point to a <code>datazoom.amazonia</code> function is
some interesting database to explore. The function you then create
should allow the user to, at the touch of a button, have the data
automatically downloaded, cleaned, and provided in the format they
desire. The diagram below summarises the process of creating a new
function.</p>
<div class="grViz html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-2ccb65c0596009d04ddb" style="width:700px;height:432.632880098888px;"></div>
<script type="application/json" data-for="htmlwidget-2ccb65c0596009d04ddb">{"x":{"diagram":"digraph {\n  graph [layout = dot, rankdir = TB]\n  \n  node [shape = rectangle]        \n  rec1 [label = \"Write code to automate the download\"]\n  rec2 [label = \"Make into a working function, following our template\"]\n  rec3 [label = \"Pick the appropriate parameters\"]\n  rec4 [label = \"Make the data as neat as possible for the user\"]\n  rec5 [label = \"Documentation and checks\"]\n  \n  # edge definitions with the node IDs\n  rec1 -> rec2 -> rec3 -> rec4 -> rec5\n  }","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level2">
<h2 id="automating-the-download">Automating the download<a class="anchor" aria-label="anchor" href="#automating-the-download"></a>
</h2>
<p>Once you’ve settled on creating some new
<strong>load_<em>database</em></strong> function, you have to figure out
how to get some piece of code to automatically download the data for
you.</p>
<p>At this point it is crucial that you understand the downloading
process yourself before teaching the machine to do it for you. That
means manually opening your browser, downloading the data and having a
look at it. Usually it’s just a simple spreadsheet – or many
spreadsheets – in <code>.csv</code> or <code>.xls</code>, but spatial
data is different and data can come in odd file extensions or be
compressed to a <code>.zip</code> file, which you’ll have to get your
code to deal with. If you run into some different edge case, it is
likely that some existing function already deals with the same issue, so
have a careful look around.</p>
<p>By downloading the data yourself manually, you should obtain a
<strong>direct download link</strong>. If you paste this URL into your
browser, the download should begin by itself. You can usually easily
copy and paste this download link from the site the data is stored at,
but another trick is to go to your browser <strong>Downloads</strong>
and try to get the link from there.</p>
<p>Once you have the URL, write up some code like this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="st">"www.../download-link/"</span></span>
<span></span>
<span><span class="co"># we can't clutter our users' PCs with random files,</span></span>
<span><span class="co"># so we create a temporary folder and save the data</span></span>
<span><span class="co"># into a temporary file therein</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".csv"</span>, tmpdir <span class="op">=</span> <span class="va">dir</span><span class="op">)</span> </span>
<span><span class="co"># fileext can be any other format  </span></span>
<span>  </span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">path</span>, destfile <span class="op">=</span> <span class="va">temp</span>, mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span>  </span></code></pre></div>
<p>If all goes according to plan, the object <code>temp</code> now
stores the path to the data you just downloaded in your computer. In
some cases, data is stored in Google Drive, which requires using the
<code>googledrive</code> package, which already has a code bit ready in
<code>external_download</code>. In other cases, this way of downloading
just fails, and you must also try</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">path</span>, destfile <span class="op">=</span> <span class="va">temp</span>, method <span class="op">=</span> <span class="st">"curl"</span><span class="op">)</span></span></code></pre></div>
<p>Depending on the file extension, opening the data entails something
like</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span><span class="co"># or</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xls</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span><span class="co"># or...</span></span></code></pre></div>
<p>Before actually creating the function, it is strongly recommended
that you get the general code above to work, at least before you’ve got
the hang of things.</p>
<p>Since basically all of your functions require very similar download
code, it would make no sense to write the same thing over and over
again. Instead, we coded the <code>external_download</code> function,
which can run each particular case we need once you specify its
parameters.</p>
<p>The next section will show you how to incorporate this code into our
more automated structure, which relies on the
<code>external_download</code> function defined in the
<code>download.R</code> file. I’d encourage you to have a look at it –
you’re not expected to understand a whole lot right now. If you can get
through the endless <em>if</em> conditions, you can see that behind such
a daunting facade lies some code pretty much like the one you just
wrote.</p>
</div>
<div class="section level2">
<h2 id="creating-the-function">Creating the function<a class="anchor" aria-label="anchor" href="#creating-the-function"></a>
</h2>
<p>Just create a <code>load_database.R</code> file in the
<code>datazoom.amazonia/R/</code> folder. You can start by just taking
your previous code and packaging it into a function</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">load_database</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="st">"www.../download-link/"</span></span>
<span></span>
<span>  <span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".csv"</span>, tmpdir <span class="op">=</span> <span class="va">dir</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">path</span>, destfile <span class="op">=</span> <span class="va">temp</span>, mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Very often, this will require some changes right off the gate. A
database usually contains more than one dataset, which can be stored in
different download URLs. This would lead to something like</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">load_database</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">dataset</span> <span class="op">==</span> <span class="st">"dataset1"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">path</span> <span class="op">&lt;-</span> <span class="st">"www.../download-link/file1"</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">dataset</span> <span class="op">==</span> <span class="st">"dataset2"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">path</span> <span class="op">&lt;-</span> <span class="st">"www.../download-link/file2"</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".csv"</span>, tmpdir <span class="op">=</span> <span class="va">dir</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">path</span>, destfile <span class="op">=</span> <span class="va">temp</span>, mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Once you get this to work, you can move on in a couple different
ways. One option is to incorporate this code into our
<code>external_download</code> framework – the code above should only
serve as a temporary aid, none of our functions actually call
<code>download.file</code> directly. The other option is to just go
ahead and complement your <code>load_database.R</code> with some data
cleaning code – this can better to start with if the database isn’t
crazy complicated.</p>
<p>If you go the former route, stick around.</p>
<div class="section level3">
<h3 id="an-external_download-explainer">An <code>external_download</code> explainer<a class="anchor" aria-label="anchor" href="#an-external_download-explainer"></a>
</h3>
<p>If you scroll down the <code>download.R</code> file, you’ll reach the
<code>external_download</code> function. Now keep scrolling all the way
down and you’ll find <code>datasets_link</code>. THis function is how we
actually store all the download URLs we need instead of manually pasting
them into the body of our functions.</p>
<p>It looks something like this</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datasets_link</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co">## Add file type at the end in order to set the Curl Process</span></span>
<span></span>
<span>  <span class="va">link</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>    <span class="op">~</span><span class="va">survey</span>, <span class="op">~</span><span class="va">dataset</span>, <span class="op">~</span><span class="va">sidra_code</span>, <span class="op">~</span><span class="va">available_time</span>, <span class="op">~</span><span class="va">available_geo</span>, <span class="op">~</span><span class="va">link</span>,</span>
<span>    <span class="st">"PAM-IBGE"</span>, <span class="st">"all_crops"</span>, <span class="st">"5457/all/all"</span>, <span class="st">"1974-2020"</span>, <span class="st">"Country, State, Municipality"</span>, <span class="st">"https://sidra.ibge.gov.br/pesquisa/pam/tabelas"</span>,</span>
<span>    </span>
<span>    <span class="co"># ...</span></span>
<span>    </span>
<span>    <span class="st">"..."</span>, <span class="st">"..."</span>, <span class="st">"..."</span>, <span class="st">"..."</span>, <span class="st">"..."</span>, <span class="st">"..."</span>,</span>
<span>    </span>
<span>    <span class="co"># ...</span></span>
<span>    </span>
<span>    <span class="co">############</span></span>
<span>    <span class="co">## IMAZON ##</span></span>
<span>    <span class="co">############</span></span>
<span></span>
<span>    <span class="st">"Imazon"</span>, <span class="st">"imazon_shp"</span>, <span class="cn">NA</span>, <span class="st">"2020"</span>, <span class="st">"Municipality"</span>, <span class="st">"https://drive.google.com/drive/u/1/folders/1EAOABo1GVKT3YsYkhtgJI9ckB3RULJSC"</span>,</span>
<span></span>
<span>    <span class="co">## Shapefile from github repository</span></span>
<span></span>
<span>    <span class="st">"Internal"</span>, <span class="st">"geo_municipalities"</span>, <span class="cn">NA</span>, <span class="st">"2020"</span>, <span class="st">"Municipality"</span>, <span class="st">"https://raw.github.com/datazoompuc/datazoom.amazonia/master/data-raw/geo_municipalities.rds"</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">link</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If you actually run it, you’ll see that it just creates a data
frame</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">datasets_link</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 6</span></span></span>
<span><span class="co">#&gt;   survey   dataset            sidra_code   available_time available_geo    link </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> PAM-IBGE all_crops          5457/all/all 1974-2020      Country, State,… http…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ...      ...                ...          ...            ...              ...  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Imazon   imazon_shp         <span style="color: #BB0000;">NA</span>           2020           Municipality     http…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Internal geo_municipalities <span style="color: #BB0000;">NA</span>           2020           Municipality     http…</span></span></code></pre></div>
<p>At the start of the <code>external_download</code> code, you can see
that it’s used right away</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Create Basic Url</span></span>
<span></span>
<span>  <span class="va">dat_url</span> <span class="op">&lt;-</span> <span class="fu">datasets_link</span><span class="op">(</span><span class="op">)</span> <span class="co"># stores the whole data frame</span></span>
<span></span>
<span>  <span class="va">param</span><span class="op">$</span><span class="va">url</span> <span class="op">&lt;-</span> <span class="va">dat_url</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dataset</span> <span class="op">==</span> <span class="va">param</span><span class="op">$</span><span class="va">dataset</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># picks only the row</span></span>
<span>                                          <span class="co"># with the dataset you want</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">link</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># only grabs the column with the link</span></span>
<span>    <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># turns it from a tibble to a vector</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>So, when you make a new function, you should add a new row to
<code>datasets_link</code> for each dataset you need</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datasets_link</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co">## Add file type at the end in order to set the Curl Process</span></span>
<span></span>
<span>  <span class="va">link</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># ...</span></span>
<span>    </span>
<span>    <span class="co">###################</span></span>
<span>    <span class="co">## Your Database ##</span></span>
<span>    <span class="co">###################</span></span>
<span></span>
<span>    <span class="st">"Database"</span>, <span class="st">"dataset1"</span>, <span class="cn">NA</span>, <span class="st">"2020"</span>, <span class="st">"Municipality"</span>, <span class="st">"https://www..."</span>,</span>
<span>    <span class="st">"Database"</span>, <span class="st">"dataset2"</span>, <span class="cn">NA</span>, <span class="st">"2020"</span>, <span class="st">"Municipality"</span>, <span class="st">"https://www..."</span>,</span>
<span></span>
<span>    <span class="co">## Shapefile from github repository</span></span>
<span></span>
<span>    <span class="st">"Internal"</span>, <span class="st">"geo_municipalities"</span>, <span class="cn">NA</span>, <span class="st">"2020"</span>, <span class="st">"Municipality"</span>, <span class="st">"https://raw.github.com/datazoompuc/datazoom.amazonia/master/data-raw/geo_municipalities.rds"</span>,</span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">link</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then, instead of having to write
<code>url &lt;- "https://www..."</code> in your code,
<code>external_download</code> just grabs it from
<code>datasets_link()</code> and stores it into
<code>dat_url</code>.</p>
<p>The next section of <code>external_download</code> is</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">#####################</span></span>
<span>  <span class="co">## Construct Links ##</span></span>
<span>  <span class="co">#####################</span></span>
<span></span>
<span>  <span class="va">...</span></span>
<span></span>
<span>  <span class="co">###################</span></span>
<span>  <span class="co">## Your Database ##</span></span>
<span>  <span class="co">###################</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op">==</span> <span class="st">"database"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">path</span> <span class="op">&lt;-</span> <span class="va">param</span><span class="op">$</span><span class="va">url</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">...</span></span>
<span>  </span></code></pre></div>
<p><code>path</code> is the object that actually goes into
<code><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file()</a></code>. Depending on the dataset, you may have to
paste something at the end of the URL for different years or datasets,
and this is what that section is for.</p>
<p>What comes next is</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">#######################</span></span>
<span>  <span class="co">## Initiate Download ##</span></span>
<span>  <span class="co">#######################</span></span>
<span></span>
<span>  <span class="co">## We should be careful when the downloaded files is terminated in .xlsx</span></span>
<span></span>
<span>  <span class="va">file_extension</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">path</span>, <span class="op">-</span><span class="fl">4</span><span class="op">)</span> <span class="co"># grabs the last 4 characters</span></span>
<span>                                    <span class="co"># of your download link.</span></span>
<span></span>
<span>  <span class="co"># if it's something like "www.../file.csv", you'se all set.</span></span>
<span>  <span class="co"># file_extension will be automatically ".csv"</span></span>
<span></span>
<span>  <span class="va">...</span></span>
<span>  </span>
<span>  <span class="co"># in case something's off, or your file extension doesn't have</span></span>
<span>  <span class="co"># exactly 3 characters, you have to specify</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op">==</span> <span class="st">"database"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">file_extension</span> <span class="op">&lt;-</span> <span class="st">".xxxx"</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">...</span></span></code></pre></div>
<p>And finally, the next section is the most important</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Define Empty Directory and Files For Download</span></span>
<span></span>
<span>  <span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="va">file_extension</span>, tmpdir <span class="op">=</span> <span class="va">dir</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Picking the way to download the file</span></span>
<span></span>
<span>  <span class="va">download_method</span> <span class="op">&lt;-</span> <span class="st">"standard"</span> <span class="co"># works for most functions</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iema"</span>, <span class="st">"imazon_shp"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">download_method</span> <span class="op">&lt;-</span> <span class="st">"googledrive"</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"deter"</span>, <span class="st">"terraclimate"</span>, <span class="st">"baci"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">download_method</span> <span class="op">&lt;-</span> <span class="st">"curl"</span></span>
<span>    <span class="va">quiet</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ibama"</span>, <span class="st">"health"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">download_method</span> <span class="op">&lt;-</span> <span class="st">"curl"</span></span>
<span>    <span class="va">quiet</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op">==</span> <span class="st">"seeg"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">geo_level</span> <span class="op">==</span> <span class="st">"municipality"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">download_method</span> <span class="op">&lt;-</span> <span class="st">"googledrive"</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">source</span> <span class="op">==</span> <span class="st">"mapbiomas"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">dataset</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mapbiomas_cover"</span>, <span class="st">"mapbiomas_transition"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">param</span><span class="op">$</span><span class="va">geo_level</span> <span class="op">==</span> <span class="st">"municipality"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">download_method</span> <span class="op">&lt;-</span> <span class="st">"googledrive"</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">## Downloading file by the selected method</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">download_method</span> <span class="op">==</span> <span class="st">"standard"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">path</span>, destfile <span class="op">=</span> <span class="va">temp</span>, mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">download_method</span> <span class="op">==</span> <span class="st">"curl"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">path</span>, destfile <span class="op">=</span> <span class="va">temp</span>, method <span class="op">=</span> <span class="st">"curl"</span>, quiet <span class="op">=</span> <span class="va">quiet</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">download_method</span> <span class="op">==</span> <span class="st">"googledrive"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Please follow the steps from `googledrive` package to download the data. This may take a while."</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">googledrive</span><span class="fu">::</span><span class="fu"><a href="https://googledrive.tidyverse.org/reference/drive_download.html" class="external-link">drive_download</a></span><span class="op">(</span><span class="va">path</span>, path <span class="op">=</span> <span class="va">temp</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>A lot of this should look very familiar! Understanding this part is
left as an essential exercise for the reader. You must pick which
download method you want for your function, specifying it in one of the
conditions above.</p>
<p>From now on, the function also automatically reads your data
depending on the <code>file_extension</code>.</p>
<p>So, once you’ve added all you need to <code>download.R</code>, you
should be able to download your data automatically by adding your
changes to the package with <code><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">devtools::load_all()</a></code> and
running</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">external_download</span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="st">"database"</span>,</span>
<span>    dataset <span class="op">=</span> <span class="st">"dataset1"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Add it to your function instead of that more manual download and make
the whole thing look like the template in the next section.</p>
</div>
<div class="section level3">
<h3 id="the-function-template">The function template<a class="anchor" aria-label="anchor" href="#the-function-template"></a>
</h3>
<p>Pretty much all of our functions follow the format below. Do not
underestimate the utility of <code>#</code> comments and the big section
separators such as for <code>## Bind Global Variables</code>. They make
code a lot clearer. Add as many comments as possible, try to always
explain what you’re doing!</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @title Database - some explanation</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' ...</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' This is the Roxygen skeleton, which is generated automatically,</span></span>
<span><span class="co">#' and once you fill it up with info, it creates the function help file</span></span>
<span><span class="va">load_database</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span> <span class="op">=</span> <span class="st">"default_dataset"</span>,</span>
<span>                          <span class="va">raw_data</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                          <span class="va">time_period</span>, <span class="co"># no default year, user must choose</span></span>
<span>                          <span class="va">language</span> <span class="op">=</span> <span class="st">"eng"</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co">###########################</span></span>
<span>  <span class="co">## Bind Global Variables ##</span></span>
<span>  <span class="co">###########################</span></span>
<span></span>
<span>  <span class="va">a</span> <span class="op">&lt;-</span> <span class="va">b</span> <span class="op">&lt;-</span> <span class="va">...</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="co"># A technicality that will come up later</span></span>
<span></span>
<span>  <span class="co">#############################</span></span>
<span>  <span class="co">## Define Basic Parameters ##</span></span>
<span>  <span class="co">#############################</span></span>
<span></span>
<span>  <span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">param</span><span class="op">$</span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="va">dataset</span></span>
<span>  <span class="va">param</span><span class="op">$</span><span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="va">raw_data</span></span>
<span>  <span class="va">param</span><span class="op">$</span><span class="va">time_period</span> <span class="op">&lt;-</span> <span class="va">time_period</span></span>
<span>  <span class="va">param</span><span class="op">$</span><span class="va">language</span> <span class="op">&lt;-</span> <span class="va">language</span></span>
<span>  </span>
<span>  <span class="co"># All parameters are packed into a list. This makes the code a lot more</span></span>
<span>  <span class="co"># readable, as you always know when a parameter is called.</span></span>
<span>  <span class="co"># From here on, you'll never call the dataset object, but param$dataset.</span></span>
<span></span>
<span>  <span class="co">#################</span></span>
<span>  <span class="co">## Downloading ##</span></span>
<span>  <span class="co">#################</span></span>
<span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">external_download</span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="st">"database"</span>,</span>
<span>    dataset <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">dataset</span>,</span>
<span>    <span class="va">...</span> <span class="co"># maybe something else is required, such as a year option</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Return Raw Data</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">raw_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">######################</span></span>
<span>  <span class="co">## Data Engineering ##</span></span>
<span>  <span class="co">######################</span></span>
<span></span>
<span>  <span class="co"># All the cleaning and wrangling you find appropriate</span></span>
<span>  </span>
<span>  <span class="co">################################</span></span>
<span>  <span class="co">## Harmonizing Variable Names ##</span></span>
<span>  <span class="co">################################</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">language</span> <span class="op">==</span> <span class="st">"eng"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat_mod</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>        <span class="va">...</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">language</span> <span class="op">==</span> <span class="st">"pt"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat_mod</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>        <span class="va">...</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dat_mod</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="parameters">Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h2>
</div>
<div class="section level2">
<h2 id="data-engineering">Data Engineering<a class="anchor" aria-label="anchor" href="#data-engineering"></a>
</h2>
</div>
<div class="section level2">
<h2 id="documentation-and-checks">Documentation and Checks<a class="anchor" aria-label="anchor" href="#documentation-and-checks"></a>
</h2>
<div class="section level3">
<h3 id="checklist">Checklist<a class="anchor" aria-label="anchor" href="#checklist"></a>
</h3>
<ul>
<li><p>Run <code><a href="https://devtools.r-lib.org/reference/check.html" class="external-link">devtools::check</a></code>, make sure there are no notes,
warnings, or errors</p></li>
<li><p>Run <code>styler::style_file()</code></p></li>
<li><p>Test all possibilities</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="the-structure-of-the-functions">The Structure of the functions<a class="anchor" aria-label="anchor" href="#the-structure-of-the-functions"></a>
</h2>
<p><strong>1. Bind Global Variables:</strong> The goal is to ensure that
all the variables in the function were initialized to some value. We
also do this to avoid errors when we check the function.</p>
<p><strong>2. Define Basic Parameters:</strong> Create a list with all
the parameters from the function. The list <em>param</em> will be an
organized list with all the parameters of interest.</p>
<p><strong>3. Download Data:</strong> In the majority of our functions,
we download data by using external_download(). However, when we download
data from IBGE, we use a function called sidra_download(). Both of these
functions can be found in the “download.R” file.</p>
<p><strong>4. Data Engineering:</strong> In this section of the code, we
(i) exclude variables that we judge not to be relevant;(ii) sometimes we
change the class of some variables; (iii) sometimes we change data to be
organized in the long format or in the wide format depending on what we
want; (iv) generally speaking, it’s in this part of the code that we
make the most changes in the original Data Frame.</p>
<p><strong>5. Harmonizing Variable Names:</strong> Rename columns with
better names.</p>
<p><strong>6. Load Dictionary:</strong> In the functions that work with
IBGE’s data, we use the function “load_dictionary()”. This function
creates an organized correspondence between the code of each product,
its name, its unit of measure and other attributes.</p>
<p><strong>7. Translation / add variables:</strong> After having
organized the Data Frame, we then translate it. In some functions, the
translation will start in a section called “Labelling” and data from the
“dictionary.R” file will be used. In other functions, you will see the
names of the columns being translated first and then each line of the
original Data Frame will be translated.</p>
<p><strong>8. Return Data Frame:</strong> In the structure of our
functions, you will see <strong>(raw_data == TRUE){return(dat)}</strong>
right after “Downloading Data”. All the changes explained in this
document will only happen in case the user specifies <strong>(raw_data
== FALSE)</strong>.</p>
</div>
<div class="section level2">
<h2 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h2>
<p><strong>1. Bind Global Variables:</strong> example from
<em>load_cempre()</em></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sidra_code</span> <span class="op">&lt;-</span> <span class="va">available_time</span> <span class="op">&lt;-</span> <span class="va">AMZ_LEGAL</span> <span class="op">&lt;-</span> <span class="va">municipio_codigo</span> <span class="op">&lt;-</span> <span class="va">ano</span> <span class="op">&lt;-</span> <span class="va">ano_codigo</span> <span class="op">&lt;-</span> <span class="va">classificacao_nacional_de_atividades_economicas_cnae_2_0_codigo</span> <span class="op">&lt;-</span> <span class="va">geo_id</span> <span class="op">&lt;-</span> <span class="va">id_code</span> <span class="op">&lt;-</span> <span class="va">nivel_territorial</span> <span class="op">&lt;-</span> <span class="va">nivel_territorial_codigo</span> <span class="op">&lt;-</span> <span class="va">valor</span> <span class="op">&lt;-</span> <span class="va">variavel</span> <span class="op">&lt;-</span> <span class="va">unidade_de_medida</span> <span class="op">&lt;-</span> <span class="va">unidade_de_medida_codigo</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p><strong>2. Define Basic Parameters:</strong> example from
<em>load_deter()</em></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># param=list()</span></span>
<span><span class="co">#  param$dataset = dataset</span></span>
<span><span class="co">#  param$time_period = time_period</span></span>
<span><span class="co">#  param$language = language</span></span>
<span><span class="co">#  param$raw_data = raw_data</span></span>
<span><span class="co">#  param$survey_name = datasets_link() %&gt;%</span></span>
<span><span class="co">#    dplyr::filter(dataset == param$dataset) %&gt;%</span></span>
<span><span class="co">#    dplyr::select(survey) %&gt;%</span></span>
<span><span class="co">#    unlist()</span></span>
<span><span class="co">#  param$url = datasets_link() %&gt;%</span></span>
<span><span class="co">#    dplyr::filter(dataset == param$dataset) %&gt;%</span></span>
<span><span class="co">#    dplyr::select(link) %&gt;%</span></span>
<span><span class="co">#    unlist()</span></span></code></pre></div>
<p><strong>3. Download Data:</strong> example from
<em>load_degrad()</em>. It uses the <em>external_download()</em>
function.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># dat = suppressWarnings(as.list(param$time_period) %&gt;%</span></span>
<span><span class="co">#      purrr::map(</span></span>
<span><span class="co">#        function(t){external_download(dataset = param$dataset,</span></span>
<span><span class="co">#                                      source='degrad', year = t) %&gt;%</span></span>
<span><span class="co">#            janitor::clean_names()</span></span>
<span><span class="co">#        }</span></span>
<span><span class="co">#      ))</span></span></code></pre></div>
<p><strong>4. Data Engineering</strong>: example from
<em>load_pam()</em>. In this process, we decided to exclude some columns
and convert the variable “valor” to become numeric. After that we
excluded all the lines with <strong>NA</strong>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># dat = dat %&gt;%</span></span>
<span><span class="co">#           janitor::clean_names() %&gt;%</span></span>
<span><span class="co">#           dplyr::mutate_all(function(var){stringi::stri_trans_general(str=var,id="Latin-ASCII")})# %&gt;%</span></span>
<span>          <span class="co"># dplyr::mutate_all(clean_custom)</span></span>
<span><span class="co">#   dat = dat %&gt;%</span></span>
<span><span class="co">#     dplyr::select(-c(nivel_territorial_codigo,nivel_territorial,ano_codigo)) %&gt;%</span></span>
<span><span class="co">#     dplyr::mutate(valor=as.numeric(valor))</span></span>
<span><span class="co">#   dat = dat %&gt;%</span></span>
<span><span class="co">#     dplyr::filter(!is.na(valor))</span></span></code></pre></div>
<p><strong>5. Harmonizing Variable Names:</strong> example from
<em>load_pam()</em>. We localize some datasets by using their numerical
codes and within each of these datasets we renamed some columns.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># if (param$code == 5457){</span></span>
<span><span class="co">#     dat = dat %&gt;%</span></span>
<span><span class="co">#       dplyr::rename(produto_das_lavouras_codigo = produto_das_lavouras_temporarias_e_permanentes_codigo,</span></span>
<span><span class="co">#                     produto_das_lavouras = produto_das_lavouras_temporarias_e_permanentes)</span></span>
<span><span class="co">#   }</span></span>
<span><span class="co">#   if (param$code == 1613){</span></span>
<span><span class="co">#     dat = dat %&gt;%</span></span>
<span><span class="co">#       dplyr::rename(produto_das_lavouras_codigo = # produto_das_lavouras_permanentes_codigo,</span></span>
<span><span class="co">#                     produto_das_lavouras = produto_das_lavouras_permanentes)</span></span>
<span><span class="co">#   }</span></span>
<span><span class="co">#   if (param$code %in% c(839,1000,1001,1002,1612)){</span></span>
<span><span class="co">#     dat = dat %&gt;%</span></span>
<span><span class="co">#       dplyr::rename(produto_das_lavouras_codigo = # produto_das_lavouras_temporarias_codigo,</span></span>
<span><span class="co">#                   produto_das_lavouras = produto_das_lavouras_temporarias)</span></span>
<span><span class="co">#   }</span></span></code></pre></div>
<p><strong>6. Load Dictionary:</strong> example from
<em>load_pam()</em>. For functions with data from IBGE, we load the
dictionary and then we convert the variable “var_code” to become a
character. Finally we exclude the observations where var_code ==
“0”.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># dic = load_dictionary(param$dataset)</span></span>
<span><span class="co">#  types = as.character(dic$var_code)</span></span>
<span><span class="co">#  types = types[types != "0"] </span></span></code></pre></div>
<p><strong>7. Translation / add variables:</strong> example from
<em>load_degrad()</em>.This section translates the names of the columns
of the original Data Frame.In this example, the original columns
(variables) were in English and therefore we translated it to Portuguese
in case the user chooses it.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># if (param$language == 'pt'){</span></span>
<span><span class="co">#    dat_mod = dat %&gt;%</span></span>
<span><span class="co">#      dplyr::select(ano = year, linkcolumn, scene_id,</span></span>
<span><span class="co">#                    cod_uf = code_state, cod_municipio = code_muni,</span></span>
<span><span class="co">#                    classe = class_name, pathrow, area, data = view_date,</span></span>
<span><span class="co">#                    julday, geometry</span></span>
<span><span class="co">#      ) %&gt;%</span></span>
<span><span class="co">#      dplyr::arrange(ano, cod_municipio, classe)</span></span>
<span><span class="co">#  }</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Francisco de Lima Cavalcanti, DataZoom (PUC-Rio), Guilherme Jardim, Daniel AC Barbosa, Bruno Alcantara Duarte, Fredie Didier, Tito Bruni, Luiz Guilherme Lopes Moussatche, Victor Aliende da Matta, Anna Carolina Dutra Saraiva, Arthur Carvalho Brito, Igor Rigolon Veiga, Maria Mittelbach.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
